/*
 * Copyright (c) 2022, Salesforce.com, Inc.
 * All rights reserved.
 * SPDX-License-Identifier: BSD-3-Clause
 * For full license text, see the LICENSE file in the repo root or https://opensource.org/licenses/BSD-3-Clause
 */
class SFlameGraph{#flameSvgRowHeight=16;#flameMaxSvgHeight=128*this.#flameSvgRowHeight;#flameSvgHeight=0;#flameSvgWidth=1e3;#flameGraphActiveTree=void 0;#flameGraphSearch=!1;#flameGraphSearchStr="";#flameGraphPath="";#flameGraphClickDepth=0;#SFlameGraphTooltip=void 0;#SFlameGraphDiv="#flame-graph-guid";#SFlameGraphDetailsDiv="#flame-graph-details-guid";#SFlameGraphCustomMenuDiv="#custom-menu-guid";#threshold=.01;#sizeKey="sz";#leftKey="bsz";#rightKey="csz";#pixelThreshold=.5;#filterOption=1;#isCompare=!1;#searchMatchCount=0;getSearchMatchCount(){return SFlameGraph.instance.#searchMatchCount}constructor(){return SFlameGraph.instance||(SFlameGraph.instance=this),SFlameGraph.instance}setRightKey(e){SFlameGraph.instance.#rightKey=e}setLeftKey(e){SFlameGraph.instance.#leftKey=e}setPixelThreshold(e){SFlameGraph.instance.#pixelThreshold=e}setFilterOption(e){SFlameGraph.instance.#filterOption=e}setIsCompare(e){SFlameGraph.instance.#isCompare=e}setThreshold(e){SFlameGraph.instance.#threshold=e}setSizeKey(e){SFlameGraph.instance.#sizeKey=e}setSFlameGraphDivId(e){SFlameGraph.instance.#SFlameGraphDiv=e}setSFlameGraphDetailsDiv(e){SFlameGraph.instance.#SFlameGraphDetailsDiv=e}setSFlameGraphCustomMenuDiv(e){SFlameGraph.instance.#SFlameGraphCustomMenuDiv=e}showTreeV1Flame(e,a){$(SFlameGraph.instance.#SFlameGraphDiv).html("<br><br><b>Note: Work in progress ...</b>")}genSVG(a,t,n,e,l){if(100*a[SFlameGraph.instance.#sizeKey]/t<SFlameGraph.instance.#threshold)return!1;let r=!1,m=(null==a.ch&&(a.ch=[]),e),i=0;return a.ch.forEach(function(e){r||void 0===e[SFlameGraph.instance.#sizeKey]||0===e[SFlameGraph.instance.#sizeKey]||isSkipSubtree(e[SFlameGraph.instance.#sizeKey],0)||(100*e[SFlameGraph.instance.#sizeKey]/t<SFlameGraph.instance.#threshold?(1<a.ch.length?SFlameGraph.instance.addSVGRect(e,t,"...",m,l+i+":",n):SFlameGraph.instance.addSVGRect(e,t,"...",m,l,n),r=!0):0<a.ch.length&&(1<a.ch.length?(SFlameGraph.instance.addSVGRect(e,t,e.nm,m,l+i+":",n),SFlameGraph.instance.genSVG(e,t,n+1,m,l+i+":")||SFlameGraph.instance.addSVGRect(e,t,"...",m,l,n)):(SFlameGraph.instance.addSVGRect(e,t,e.nm,m,l,n),SFlameGraph.instance.genSVG(e,t,n+1,m,l)||SFlameGraph.instance.addSVGRect(e,t,"...",m,l,n)),m+=SFlameGraph.instance.#flameSvgWidth*e[SFlameGraph.instance.#sizeKey]/t),i++)}),!0}addSVGRect(e,a,t,n,l,r,m=!1){let i=e[SFlameGraph.instance.#sizeKey]/a,h=e[SFlameGraph.instance.#sizeKey];if(SFlameGraph.instance.#flameSvgHeight<SFlameGraph.instance.#flameSvgRowHeight*r&&(SFlameGraph.instance.#flameSvgHeight=SFlameGraph.instance.#flameSvgRowHeight*r),!(SFlameGraph.instance.#flameSvgWidth*i<SFlameGraph.instance.#pixelThreshold&&1<r&&0==SFlameGraph.instance.#flameGraphClickDepth)){let e=getFrameName(t);d3.select("#flamegraphdiv").select("svg").append("rect").attr("width",SFlameGraph.instance.#flameSvgWidth*i).attr("height",SFlameGraph.instance.#flameSvgRowHeight).attr("p",l).attr("d",r).attr("x",n).attr("y",SFlameGraph.instance.#flameMaxSvgHeight-SFlameGraph.instance.#flameSvgRowHeight*r).attr("stroke",SFlameGraph.instance.#flameSvgWidth*i<3?"none":"white").attr("fill",SFlameGraph.instance.getFlameColor(m,t)).attr("class","testclass").attr("onclick","SFlameGraph.instance.svgShowFlame(evt)").attr("id",t).on("contextmenu",function(){return SFlameGraph.instance.flameGraphcontextMenu(e)}).on("mouseover",function(){return SFlameGraph.instance.mouseoverFlame(t,this,i*SFlameGraph.instance.#flameSvgWidth)}).on("mousemove",function(){return SFlameGraph.instance.mousemoveFlame(t,this,h,a)}).on("mouseleave",function(){return SFlameGraph.instance.mouseleaveFlame(t,this)}),50<=SFlameGraph.instance.#flameSvgWidth*i&&d3.select("#flamegraphdiv").select("svg").append("text").text(SFlameGraph.instance.getFlameRectText(i*SFlameGraph.instance.#flameSvgWidth,e)).attr("x",n+3).attr("y",SFlameGraph.instance.#flameMaxSvgHeight-SFlameGraph.instance.#flameSvgRowHeight*r+12).attr("fill","black").style("font-size","14px").style("font-family",'"Open Sans", sans-serif').attr("onclick","SFlameGraph.instance.svgShowFlame(evt)").attr("id",t).attr("p",l).attr("d",r).on("contextmenu",function(){return SFlameGraph.instance.flameGraphcontextMenu(e)}).on("mouseover",function(){return SFlameGraph.instance.mouseoverFlame(t,this,i*SFlameGraph.instance.#flameSvgWidth)}).on("mousemove",function(){return SFlameGraph.instance.mousemoveFlame(t,this,h,a)}).on("mouseleave",function(){return SFlameGraph.instance.mouseleaveFlame(t,this)})}}svgShowFlame(e){var a,e=e.target;null!=e.getAttribute("style")&&e.getAttribute("style").includes("opacity: 0")||(a=e.getAttribute("p").split(":"),e=Number(e.getAttribute("d")),SFlameGraph.instance.#flameGraphPath=a,SFlameGraph.instance.#flameGraphClickDepth=e,SFlameGraph.instance.#isCompare?SFlameGraph.instance.showClickedFlameCompare(a,e):SFlameGraph.instance.showClickedFlame(a,e))}showClickedFlame(l,r){if(d3.select("#flamegraphdiv").select("svg").selectAll("*").remove(),1==l.length&&1==r)SFlameGraph.instance.#flameGraphPath="",SFlameGraph.instance.#flameGraphClickDepth=0,SFlameGraph.instance.addSVGRect(SFlameGraph.instance.#flameGraphActiveTree,SFlameGraph.instance.#flameGraphActiveTree[SFlameGraph.instance.#sizeKey],SFlameGraph.instance.#flameGraphActiveTree.nm,0,"",1),SFlameGraph.instance.genSVG(SFlameGraph.instance.#flameGraphActiveTree,SFlameGraph.instance.#flameGraphActiveTree[SFlameGraph.instance.#sizeKey],2,0,"");else{SFlameGraph.instance.addSVGRect(SFlameGraph.instance.#flameGraphActiveTree,SFlameGraph.instance.#flameGraphActiveTree[SFlameGraph.instance.#sizeKey],SFlameGraph.instance.#flameGraphActiveTree.nm,0,"",1,!0);let e=SFlameGraph.instance.#flameGraphActiveTree,a=1,t=0,n="";for(;a<r;){for(;1==e.ch.length&&a<r;)e=e.ch[0],++a==r?(SFlameGraph.instance.addSVGRect(e,e[SFlameGraph.instance.#sizeKey],e.nm,0,n,a),SFlameGraph.instance.genSVG(e,e[SFlameGraph.instance.#sizeKey],a+1,0,n)):SFlameGraph.instance.addSVGRect(e,e[SFlameGraph.instance.#sizeKey],e.nm,0,n,a,!0);a<r&&(n=n+Number(l[t])+":",a++,null==e.ch[Number(l[t])]&&console.log("warning1"),e=e.ch[Number(l[t])],a==r?(SFlameGraph.instance.addSVGRect(e,e[SFlameGraph.instance.#sizeKey],e.nm,0,n,a),SFlameGraph.instance.genSVG(e,e[SFlameGraph.instance.#sizeKey],a+1,0,n)):(null==e&&console.log("warning2"),SFlameGraph.instance.addSVGRect(e,e[SFlameGraph.instance.#sizeKey],e.nm,0,n,a,!0)),t++)}}}showTreeV1FlameCompare(e,a){$(SFlameGraph.instance.#SFlameGraphDiv).html("<br><br><b>Note: Work in progress ...</b>")}genSVGCompare(a,t,n,e,l){if(100*a[SFlameGraph.instance.#leftKey]/t<SFlameGraph.instance.#threshold&&100*a[SFlameGraph.instance.#rightKey]/t<SFlameGraph.instance.#threshold)return!1;let r=!1,m=(null==a.ch&&(a.ch=[]),e),i=0;return a.ch.forEach(function(e){r||isSkipSubtree(e[SFlameGraph.instance.#leftKey],e[SFlameGraph.instance.#rightKey])||(100*e[SFlameGraph.instance.#leftKey]/t<SFlameGraph.instance.#threshold&&100*e[SFlameGraph.instance.#rightKey]/t<SFlameGraph.instance.#threshold?(1<a.ch.length?SFlameGraph.instance.addSVGRectCompare(e,t,"...",m,l+i+":",n):SFlameGraph.instance.addSVGRectCompare(e,t,"...",m,l,n),r=!0):0<a.ch.length&&(1<a.ch.length?(SFlameGraph.instance.addSVGRectCompare(e,t,e.nm,m,l+i+":",n),SFlameGraph.instance.genSVGCompare(e,t,n+1,m,l+i+":")||SFlameGraph.instance.addSVGRectCompare(e,t,"...",m,l,n)):(SFlameGraph.instance.addSVGRectCompare(e,t,e.nm,m,l,n),SFlameGraph.instance.genSVGCompare(e,t,n+1,m,l)||SFlameGraph.instance.addSVGRectCompare(e,t,"...",m,l,n)),m+=SFlameGraph.instance.#flameSvgWidth*(e[SFlameGraph.instance.#leftKey]+e[SFlameGraph.instance.#rightKey])/t),i++)}),!0}addSVGRectCompare(a,t,n,l,r,m,i=!1){let h=(a[SFlameGraph.instance.#leftKey]+a[SFlameGraph.instance.#rightKey])/t;a[SFlameGraph.instance.#leftKey],a[SFlameGraph.instance.#rightKey];if(SFlameGraph.instance.#flameSvgHeight<SFlameGraph.instance.#flameSvgRowHeight*m&&(SFlameGraph.instance.#flameSvgHeight=SFlameGraph.instance.#flameSvgRowHeight*m),!(SFlameGraph.instance.#flameSvgWidth*h<SFlameGraph.instance.#pixelThreshold&&1<m&&0==SFlameGraph.instance.#flameGraphClickDepth)){let e=getFrameName(n);d3.select("#flamegraphdiv").select("svg").append("rect").attr("width",SFlameGraph.instance.#flameSvgWidth*h).attr("height",SFlameGraph.instance.#flameSvgRowHeight).attr("p",r).attr("d",m).attr("x",l).attr("y",SFlameGraph.instance.#flameMaxSvgHeight-SFlameGraph.instance.#flameSvgRowHeight*m).attr("stroke",SFlameGraph.instance.#flameSvgWidth*h<3?"none":"white").attr("fill",SFlameGraph.instance.getCompareFlameColor(i,a[SFlameGraph.instance.#leftKey],a[SFlameGraph.instance.#rightKey],n)).attr("class","testclass").attr("onclick","SFlameGraph.instance.svgShowFlame(evt)").attr("id",n).on("contextmenu",function(){return SFlameGraph.instance.flameGraphcontextMenu(e)}).on("mouseover",function(){return SFlameGraph.instance.mouseoverFlame(n,this,h*SFlameGraph.instance.#flameSvgWidth)}).on("mousemove",function(){return SFlameGraph.instance.mousemoveFlameCompare(n,this,a[SFlameGraph.instance.#leftKey],a[SFlameGraph.instance.#rightKey],t)}).on("mouseleave",function(){return SFlameGraph.instance.mouseleaveFlame(n,this)}),50<=SFlameGraph.instance.#flameSvgWidth*h&&d3.select("#flamegraphdiv").select("svg").append("text").text(SFlameGraph.instance.getFlameRectText(h*SFlameGraph.instance.#flameSvgWidth,e)).attr("x",l+3).attr("y",SFlameGraph.instance.#flameMaxSvgHeight-SFlameGraph.instance.#flameSvgRowHeight*m+12).attr("fill","black").style("font-size","14px").style("font-family",'"Open Sans", sans-serif').attr("onclick","SFlameGraph.instance.svgShowFlame(evt)").attr("id",n).attr("p",r).attr("d",m).on("contextmenu",function(){return SFlameGraph.instance.flameGraphcontextMenu(e)}).on("mouseover",function(){return SFlameGraph.instance.mouseoverFlame(n,this,h*SFlameGraph.instance.#flameSvgWidth)}).on("mousemove",function(){return SFlameGraph.instance.mousemoveFlameCompare(n,this,a[SFlameGraph.instance.#leftKey],a[SFlameGraph.instance.#rightKey],t)}).on("mouseleave",function(){return SFlameGraph.instance.mouseleaveFlame(n,this)})}}showClickedFlameCompare(l,r){if(d3.select("#flamegraphdiv").select("svg").selectAll("*").remove(),1==l.length&&1==r)SFlameGraph.instance.#flameGraphPath="",SFlameGraph.instance.#flameGraphClickDepth=0,SFlameGraph.instance.addSVGRectCompare(SFlameGraph.instance.#flameGraphActiveTree,SFlameGraph.instance.#flameGraphActiveTree[SFlameGraph.instance.#leftKey]+SFlameGraph.instance.#flameGraphActiveTree[SFlameGraph.instance.#rightKey],SFlameGraph.instance.#flameGraphActiveTree.nm,0,"",1),SFlameGraph.instance.genSVGCompare(SFlameGraph.instance.#flameGraphActiveTree,SFlameGraph.instance.#flameGraphActiveTree[SFlameGraph.instance.#leftKey]+SFlameGraph.instance.#flameGraphActiveTree[SFlameGraph.instance.#rightKey],2,0,"");else{SFlameGraph.instance.addSVGRectCompare(SFlameGraph.instance.#flameGraphActiveTree,SFlameGraph.instance.#flameGraphActiveTree[SFlameGraph.instance.#leftKey]+SFlameGraph.instance.#flameGraphActiveTree[SFlameGraph.instance.#rightKey],SFlameGraph.instance.#flameGraphActiveTree.nm,0,"",1,!0);let e=SFlameGraph.instance.#flameGraphActiveTree,a=1,t=0,n="";for(;a<r;){for(;1==e.ch.length&&a<r;)e=e.ch[0],++a==r?(SFlameGraph.instance.addSVGRectCompare(e,e[SFlameGraph.instance.#leftKey]+e[SFlameGraph.instance.#rightKey],e.nm,0,n,a),SFlameGraph.instance.genSVGCompare(e,e[SFlameGraph.instance.#leftKey]+e[SFlameGraph.instance.#rightKey],a+1,0,n)):SFlameGraph.instance.addSVGRectCompare(e,e[SFlameGraph.instance.#leftKey]+e[SFlameGraph.instance.#rightKey],e.nm,0,n,a,!0);a<r&&(n=n+Number(l[t])+":",a++,null==e.ch[Number(l[t])]&&console.log("warning1"),e=e.ch[Number(l[t])],a==r?(SFlameGraph.instance.addSVGRectCompare(e,e[SFlameGraph.instance.#leftKey]+e[SFlameGraph.instance.#rightKey],e.nm,0,n,a),SFlameGraph.instance.genSVGCompare(e,e[SFlameGraph.instance.#leftKey]+e[SFlameGraph.instance.#rightKey],a+1,0,n)):(null==e&&console.log("warning2"),SFlameGraph.instance.addSVGRectCompare(e,e[SFlameGraph.instance.#leftKey]+e[SFlameGraph.instance.#rightKey],e.nm,0,n,a,!0)),t++)}}}mouseoverFlame(e,a,t){$(SFlameGraph.instance.#SFlameGraphDetailsDiv).html(getFrameName(e)),null!=d3.select(a).attr("style")&&d3.select(a).attr("style").includes("opacity: 0")||(SFlameGraph.instance.#SFlameGraphTooltip.style("opacity",1),d3.select(a).style("cursor","pointer"))}mousemoveFlame(t,n,l,r){if(null==d3.select(n).attr("style")||!d3.select(n).attr("style").includes("opacity: 0")){let e=d3.mouse(n)[0],a=d3.mouse(n)[1];e+500>SFlameGraph.instance.#flameSvgWidth?e=e-7*getFrameName(t).length-130:e+=20,a+50>SFlameGraph.instance.#flameMaxSvgHeight?a-=25:a+=15,SFlameGraph.instance.#SFlameGraphTooltip.html(getFrameName(t)+" "+(100*l/r).toFixed(2)+"%, "+l+" sample(s)").style("left",e+"px").style("top",a+"px")}}mousemoveFlameCompare(n,l,r,m,e){if(null==d3.select(l).attr("style")||!d3.select(l).attr("style").includes("opacity: 0")){let e=d3.mouse(l)[0],a=d3.mouse(l)[1];e+500>SFlameGraph.instance.#flameSvgWidth?e=e-7*getFrameName(n).length-130:e+=20,a+50>SFlameGraph.instance.#flameMaxSvgHeight?a-=25:a+=15;l=r-m;let t="NA";r+m!==0&&(t=(100*l/(r+m)).toFixed(2)+"%"),SFlameGraph.instance.#SFlameGraphTooltip.html(getFrameName(n)+" base:"+r+" new:"+m+" diff:"+l+" percent:"+t).style("left",e+"px").style("top",a+"px")}}mouseleaveFlame(e,a){null!=d3.select(a).attr("style")&&d3.select(a).attr("style").includes("opacity: 0")||(SFlameGraph.instance.#SFlameGraphTooltip.style("opacity",0),d3.select(a).attr("width"),d3.select(a).style("cursor","default"))}getFlameRectText(e,a){return e/7>a.length?a:a.slice(0,e/7-4)+"..."}getCompareFlameColor(e,a,t,n){let l=a-t;return a+t!==0&&(l/=a+t),SFlameGraph.instance.#flameGraphSearch&&getFrameName(n).includes(SFlameGraph.instance.#flameGraphSearchStr)?(SFlameGraph.instance.#searchMatchCount++,e?"hsl(90, 75%, 80%)":"hsl(90, 100%, 50%)"):0===l?"hsl(0, 0%, 90%)":l<0?e?"hsl(360, 100%, 80%, "+-1*l+")":"hsl(360, 100%, 50%, "+-1*l+")":e?"hsl(240, 100%, 80%, "+l+")":"hsl(240, 100%, 50%, "+l+")"}getFlameColor(e,a){return SFlameGraph.instance.#flameGraphSearch&&getFrameName(a).includes(SFlameGraph.instance.#flameGraphSearchStr)?(SFlameGraph.instance.#searchMatchCount++,e?"hsl(90, 75%, 80%)":"hsl(90, 100%, 50%)"):(a=25+30*Math.random(),e?"hsl("+a+", 100%, 80%)":"hsl("+a+", 150%, 50%)")}flameGraphcontextMenu(t){d3.event.preventDefault();var e=d3.mouse($(SFlameGraph.instance.#SFlameGraphDiv)[0]);d3.select(SFlameGraph.instance.#SFlameGraphCustomMenuDiv).style("position","absolute").style("left",e[0]+10+"px").style("top",e[1]-10+"px").style("display","inline-block").selectAll("li").on("click",function(e,a){d3.select(SFlameGraph.instance.#SFlameGraphCustomMenuDiv).style("display","none"),0===a?SFlameGraph.instance.flamegraphcopyToClipboard(t)&&toastr_success("Copied to clipboard!"):SFlameGraph.instance.#isCompare?SFlameGraph.instance.showClickedFlameCompare([""],1):SFlameGraph.instance.showClickedFlame([""],1)}),$(document).on("click",function(){d3.select(SFlameGraph.instance.#SFlameGraphCustomMenuDiv).style("display","none")})}flamegraphcopyToClipboard(e){var a=document.createElement("textarea");return a.value=e,document.body.appendChild(a),a.select(),document.execCommand("copy"),document.body.removeChild(a),!0}isSkipSubtree(e,a){return!(!SFlameGraph.instance.#isCompare||!(0===e&&2===SFlameGraph.instance.#filterOption||0===a&&3===SFlameGraph.instance.#filterOption))}}const sFlameGraph=new SFlameGraph;Object.freeze(sFlameGraph);
